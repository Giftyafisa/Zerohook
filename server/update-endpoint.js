const fs = require("fs"); const content = fs.readFileSync("routes/users.js", "utf8"); const updated = content.replace(/router\.get\(\
\/profiles\[\s\S]*?}\);/, `router.get(\/profiles\, async (req, res) => { try { const { page = 1, limit = 20, country, city, minAge, maxAge, verificationTier, minTrustScore, maxTrustScore, category, minPrice, maxPrice, availability } = req.query; let whereClause = \WHERE
u.profile_data
IS
NOT
NULL\; const params = []; let paramIndex = 1; if (country) { whereClause += \` AND u.profile_data->>\country\ = $\${paramIndex++}\`; params.push(country); } if (city) { whereClause += \` AND u.profile_data->>\city\ ILIKE $\${paramIndex++}\`; params.push(\`%\${city}%\`); } if (minAge || maxAge) { if (minAge && maxAge) { whereClause += \` AND (u.profile_data->>\age\)::int BETWEEN $\${paramIndex++} AND $\${paramIndex++}\`; params.push(minAge, maxAge); } else if (minAge) { whereClause += \` AND (u.profile_data->>\age\)::int >= $\${paramIndex++}\`; params.push(minAge); } else if (maxAge) { whereClause += \` AND (u.profile_data->>\age\)::int <= $\${paramIndex++}\`; params.push(maxAge); } } if (verificationTier) { whereClause += \` AND u.verification_tier = $\${paramIndex++}\`; params.push(verificationTier); } if (minTrustScore || maxTrustScore) { if (minTrustScore && maxTrustScore) { whereClause += \` AND u.reputation_score BETWEEN $\${paramIndex++} AND $\${paramIndex++}\`; params.push(minTrustScore, maxTrustScore); } else if (minTrustScore) { whereClause += \` AND u.reputation_score >= $\${paramIndex++}\`; params.push(minTrustScore); } else if (maxTrustScore) { whereClause += \` AND u.reputation_score <= $\${paramIndex++}\`; params.push(maxTrustScore); } } if (category) { whereClause += \` AND u.profile_data->\serviceCategories\ ? $\${paramIndex++}\`; params.push(category); } if (minPrice || maxPrice) { if (minPrice && maxPrice) { whereClause += \` AND (u.profile_data->>\basePrice\)::numeric BETWEEN $\${paramIndex++} AND $\${paramIndex++}\`; params.push(minPrice, maxPrice); } else if (minPrice) { whereClause += \` AND (u.profile_data->>\basePrice\)::numeric >= $\${paramIndex++}\`; params.push(minPrice); } else if (maxPrice) { whereClause += \` AND (u.profile_data->>\basePrice\)::numeric <= $\${paramIndex++}\`; params.push(maxPrice); } } if (availability) { whereClause += \` AND u.profile_data->\availability\ ? $\${paramIndex++}\`; params.push(availability); } const offset = (page - 1) * limit; params.push(limit, offset); const countResult = await query(\`SELECT COUNT(*) FROM users u \${whereClause}\`, params.slice(0, -2)); const totalCount = parseInt(countResult.rows[0].count); const result = await query(\`SELECT u.id, u.username, u.email, u.profile_data, u.verification_tier, u.reputation_score, u.is_subscribed, u.subscription_tier, u.created_at, COALESCE(u.last_active, u.created_at) as last_active FROM users u \${whereClause} ORDER BY u.created_at DESC LIMIT $\${paramIndex++} OFFSET $\${paramIndex++}\`, params); res.json({ success: true, users: result.rows, pagination: { page: parseInt(page), limit: parseInt(limit), total: totalCount, pages: Math.ceil(totalCount / limit) }, filters: { country, city, minAge, maxAge, verificationTier, minTrustScore, maxTrustScore, category, minPrice, maxPrice, availability } }); } catch (error) { console.error(\Get
profiles
error:\, error); res.status(500).json({ error: \Failed
to
fetch
profiles\, details: process.env.NODE_ENV === \development\ ? error.message : undefined }); } });`); fs.writeFileSync("routes/users.js", updated, "utf8"); console.log("âœ… Profiles endpoint updated!");
